{% extends "manage.html" %}
{% load custom_filters %}
{% block title %} Monitor {% endblock %}
{% block pagetitle %} {{ msg }} {% endblock pagetitle %}

{% block meta %} <meta http-equiv="refresh" content="60"/> {% endblock meta %}

{% block css %}
<link rel="stylesheet" href="{{ URL_ROOT }}/static/yaksh/css/jquery-ui/jquery-ui.css">
<link type="stylesheet" src="{{ URL_ROOT }}/static/yaksh/css/monitor.css">
{% endblock %}

{% block script %}
<script src="{{ URL_ROOT }}/static/yaksh/js/jquery-ui.js"></script>
<script type="text/javascript" src="{{ URL_ROOT }}/static/yaksh/js/reconnecting-websocket.min.js">
</script>
<script type="text/javascript" src="{{ URL_ROOT }}/static/yaksh/js/chat.js"></script>
<script type="text/javascript" src="{{ URL_ROOT }}/static/yaksh/js/monitor.js"></script>
<script type="text/javascript" src="{{ URL_ROOT }}/static/yaksh/js/moment.js"></script>
<script type="text/javascript" src="{{ URL_ROOT }}/static/yaksh/js/moment-timezone-with-data.js">
</script>
{% if papers %}
<script src="{{ URL_ROOT }}/static/yaksh/js/jquery.tablesorter.min.js"></script>
{% endif %}
{% endblock %}

{% block content %}
<div class="container">
    <div class="yakshwell">
        {# ############################################################### #}
        {# This is rendered when we are just viewing exam/monitor #}

        {% if course_details %}
        <div class="table-wrapper-2">
            <table id="course-details" class="table table-bordered table-responsive-sm">
            <tr class="table-info">
            <th>Courses</th>
            <th> Quizzes </th>
            </tr>

            {% for course in course_details %}
            <tr>
            <td><ul class="list-group">{{course.name}} </td>

    {% for course in course_details %}
    <tr>
    <td><ul class="list-group">{{course.name}} </td>

    {% if course.get_quizzes %}
    <td>
    {% for quiz in course.get_quizzes %}
     <li class="list-group-item"><a href = "{{URL_ROOT}}/exam/manage/monitor/{{quiz.id}}/{{course.id}}/">
     {{quiz.description}}
     </a></li>
    {% endfor %}
    </td>
    {% else %}
    <td> No quiz</td>
    {% endif %}
    </ul></tr>
    {% endfor %}
    </table>
{% endif %}

{# ############################################################### #}
{# This is rendered when we are just viewing exam/monitor/quiz_num #}
{% if msg != "Monitor" %}
{% if quiz %}
{% if papers %}
<input type="hidden" id="course_id" value="{{course.id}}">
<input type="hidden" id="course_name" value="{{course.name|title}}">
<input type="hidden" id="papers" value="{{papers|length}}">
<input type="hidden" id="quiz_status" value="{{quiz.is_trial}}">
<input type="hidden" id="user_tz" value="{{user.profile.timezone}}">
<input type="hidden" id="handle" value="{{user.id}}"/>
<input type="hidden" id="chat_status" value="{{course.enable_chat}}">
{% if not course.enable_chat %}
<div class="alert alert-warning">
    <h4>Chat functionality is disabled. To enable chat
    <a href="{{URL_ROOT}}/exam/manage/toggle_chat/{{course.id}}/{{quiz.id}}">Click Here</a>
    </h4>
</div>
{% else %}
<div class="alert alert-success">
    <h4>Chat functionality is Enabled. To disable chat
    <a href="{{URL_ROOT}}/exam/manage/toggle_chat/{{course.id}}/{{quiz.id}}">Click Here</a>
    </h4>
</div>
{% endif %}
<div class="alert alert-danger" id="chat_err" style="display: none;">
    <h4>Unable to establish connection. Please try again later.</h4>
</div>
<input type="hidden" id="chat_status" value="{{course.enable_chat}}">


<p>Course Name: {{ course.name }}</p>
<p>Quiz Name: {{ quiz.description }}</p>
<p>Number of papers: {{ papers|length }} </p>
{% completed papers as completed_papers %}
 {# template tag used to get the count of completed papers #}
 <p>Papers completed: <b> {{ completed_papers }} </b></p>

{% inprogress papers as inprogress_papers %}
 {# template tag used to get the count of inprogress papers #}
 <p>Papers in progress:<b>  {{ inprogress_papers }} </b></p>

<p><a href="{{URL_ROOT}}/exam/manage/statistics/question/{{papers.0.question_paper.id}}/{{course.id}}">Question Statisitics</a></p>
<p>
   <button type="button" class="btn btn-info btn-lg" data-toggle="modal" data-target="#csvModal">
       Download CSV <span class="glyphicon glyphicon-save"></span>
   </button></p>
<table id="result-table" class="tablesorter table table table-striped">
    <thead>
    <tr>
    <th> Name </th>
    <th> Username </th>
    <th> Roll number </th>  
    <th> Institute </th>
    <th> Last question attempted </th>
    <th> Marks obtained </th>
    <th> Attempts </th>
    <th> Time Remaining </th>
    <th> Status </th>
    </tr>
    </thead>
    <tbody>
    {% for paper in latest_attempts %}
    <tr> 
        <td> <a href="{{URL_ROOT}}/exam/manage/user_data/{{paper.user.id}}/{{paper.question_paper.id}}/{{course.id}}">{{ paper.user.get_full_name.title }}</a> </td>
        <td> {{ paper.user.username }} </td>
        <td> {{ paper.user.profile.roll_number }} </td>
        <td> {{ paper.user.profile.institute }} </td>
        <td> <a data-item-id="{{paper.user.id}}_{{ paper.get_latest_attempted_question.id}}_{{paper.id}}" class="item">{{ paper.get_latest_attempted_question.summary }}</a> </td>
        <td> {{ paper.marks_obtained }} </td>
        <td> {{ paper.answers.count }} </td>
        <td id="time_left{{forloop.counter0}}"> {{ paper.time_left }} </td>
        <td id="status{{forloop.counter0}}">{{ paper.status }}</td>
        </div>
        {% endif %}

        {# ############################################################### #}
        {# This is rendered when we are just viewing exam/monitor/quiz_num #}
        {% if msg != "Monitor" %}
        {% if quiz %}
        {% if papers %}
        <div class="row">
        <div class="card col-md-4">
            <div class="row">
                <div class="col"><b>Course Name:<br>Quiz Name:<br>Number of papers:<br>Papers completed:<br>Papers in progress:</b>
                </div>
                <div class="col">                
                     {{ course.name }}<br>
                     {{ quiz.description }}<br>
                    {{ papers|length }}<br>
                    {% completed papers as completed_papers %}
                     {# template tag used to get the count of completed papers #}
                      <b class="yakshred"> {{ completed_papers }} </b><br>
                    {% inprogress papers as inprogress_papers %}
                     {# template tag used to get the count of inprogress papers #}
                     <b class="yakshred">  {{ inprogress_papers }} </b>
                </div>
            </div>
         </div>
         <div class="col">
                <p><a href="{{URL_ROOT}}/exam/manage/statistics/question/{{papers.0.question_paper.id}}/{{course.id}}" class="btn btn-primary">Question Statisitics</a></p>
                <p>
                   <button type="button" class="btn btn-info" data-toggle="modal" data-target="#csvModal">
                       Download CSV <span class="fa fa-download"></span>
                   </button></p>
         </div>
         <div class="yakshwell container-fluid">
            <div class="table-wrapper-2">
            <table id="result-table" class="tablesorter table  table-striped table-responsive-sm">
                <thead>
                <tr class="table-info">
                <th> Name </th>
                <th> Username </th>
                <th> Roll number </th>  
                <th> Institute </th>
                <th> Questions answered </th> 
                <th> Marks obtained </th>
                <th> Attempts </th>
                <th> Time Remaining </th>
                <th> Status </th>
                </tr>
                </thead>
                <tbody>
                {% for paper in latest_attempts %}
                <tr> 
                    <td> <a href="{{URL_ROOT}}/exam/manage/user_data/{{paper.user.id}}/{{paper.question_paper.id}}/{{course.id}}"><i class="fa fa-circle fa-sm"></i> {{ paper.user.get_full_name.title }}</a> </td>
                    <td> {{ paper.user.username }} </td>
                    <td> {{ paper.user.profile.roll_number }} </td>
                    <td> {{ paper.user.profile.institute }} </td>
                    <td> {{ paper.get_answered_str }} </td>
                    <td> {{ paper.marks_obtained }} </td>
                    <td> {{ paper.answers.count }} </td>
                    <td id="time_left{{forloop.counter0}}"> {{ paper.time_left }} </td>
                    <td>{{ paper.status }}</td>
                    </div>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
            {% else %}
            <p> No answer papers found for {{ quiz.description }}</p>
            {% endif %} {# if papers #}
            {% else %}
            <h4>No Quiz Found</h4>
            {% endif %}
            {% endif %}
        </div>
        <!-- CSV Modal -->
        <div class="modal fade" id="csvModal" role="dialog">
            <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal">&times;</button>
              <h3 class="modal-title">Uncheck unwanted columns</h3>
            </div>
            <form action="{{URL_ROOT}}/exam/manage/download_quiz_csv/{{ course.id }}/{{ quiz.id }}/" method="post">
                {% csrf_token %}
            <div class="modal-body">
                {% for field in csv_fields %}
                <div class="form-check form-check-inline">
                  <label class="form-check-label">
                      <input class="form-check-input" name="csv_fields" type="checkbox" value="{{ field }}" checked> {{ field }}
                  </label>
                </div>
                {% endfor %}
                <b>Select Attempt Number: Default latest attempt</b>
                <select class="form-control" name = "attempt_number">
                    {%for attempt_number in attempt_numbers %}
                    {% if forloop.last %}
                    <option value="{{ attempt_number }}" selected>{{ attempt_number }} (Latest)</option>
                    {% else %}
                    <option value = "{{ attempt_number }}"> {{ attempt_number }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary"> Download <span class="glyphicon glyphicon-save"></span></button>
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            </form>
            </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialog to show students' latest submitted answer -->
<div id="ans_dialog" title="Attempt Information" style="display: none;">
    <p id="latest_ans"></p>
    <button id="open_chat" class="btn btn-primary btn-sm"> Send Message </button>
</div>


{% endblock %}

<!-- Open chat container -->
{% block postchat %}
<form id="chatform">
<div class="panel-footer">
  <div class="input-group">
    <div id="message" g_editable="true" role="textbox" contenteditable="true" placeholder="Write your message here...">
    </div>
    <span class="input-group-btn">
    <button class="btn btn-primary btn-sm" id="btn-chat">Send</button>
    </span>
  </div>
</div>
</form>
{% endblock %}
